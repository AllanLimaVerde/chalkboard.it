<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>drawIt</title>
    <style>
        body{
            margin: 0px;
            padding: 0px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-items: center;
            touch-action: none;
        }
        canvas{
            box-shadow: rgb(206, 189, 189) 50px 10px 10px;
            background: rgb(34, 34, 34);
        }
        .color-bar{
            width: 300px;
            height: 5%;
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 6px;
            /* background-image: linear-gradient(to right, red , orange, yellow, green, blue, indigo, purple, red); */
            background: linear-gradient(90deg, rgba(255,0,0,1) 0%, rgba(255,154,0,1) 10%, rgba(208,222,33,1) 20%, rgba(79,220,74,1) 30%, rgba(63,218,216,1) 40%, rgba(47,201,226,1) 50%, rgba(28,127,238,1) 60%, rgba(95,21,242,1) 70%, rgba(186,12,248,1) 80%, rgba(251,7,217,1) 90%, rgba(255,0,0,1) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .color-picker{
            position: absolute;
            pointer-events: none;
            width: 5%;
            height: 100%;
            left: 50%;
            border-radius: 6px;
            /* background: white; */
            border: 3px solid white;
            box-shadow: rgb(92, 92, 92) 1px 1px 1px;
            transform: translateX(-50%)
        }
        .clear-text{
            color: white;
            font-size: x-large;
            text-decoration: underline;
            position: absolute;
            bottom: 5%;
            left: 5%;
            cursor: pointer;
            box-shadow: rgb(92, 92, 92) 1px 1px 1px;
        }
    </style>
</head>
<body>
    <div class="clear-text" id="clear-text">
        <text>Clear<text/>
    </div>

    <div class="color-bar" id="color-bar">
        <div class="color-picker" id="color-picker"></div>
    </div>
    
    <canvas
        id="drawIt"
        width="100%"
        height="100%"
    >
    </canvas>
</body>
<script>
    const canvas = document.querySelector('canvas')
    const colorBar = document.getElementById('color-bar')
    const colorPicker = document.getElementById('color-picker')
    const clearText = document.getElementById('clear-text')

    canvas.width = window.innerWidth
    canvas.height = window.innerHeight

    const ctx = canvas.getContext('2d')

    const fps = 10;
    const background = 'rgb(34, 34, 34)'
    var drawColor = 'white'
    var drawSize = 50

    var pointsArray = []
    var buttonDown = false
    var buttonDownColorBar = false

    const drawPoint = (pos, color = drawColor, size = drawSize) => {
        ctx.fillStyle = color;
        ctx.beginPath()
        ctx.arc(pos[0], pos[1], size, 0, 2 * Math.PI)
        ctx.fill()
    }

    const clearScreen = () => {
        ctx.fillStyle = background;
        ctx.fillRect(0,0,canvas.clientWidth, canvas.height)
    }

    const onWindowResize = () => {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
    }

    const mouseDown = event => {
        buttonDown = true
        const pos = [event.clientX, event.clientY]
        drawPoint(pos, drawColor, drawSize)
        
        const point = {pos, color: drawColor, r: drawSize}
        pointsArray.push(point)
        sendPoint(point)
    }

    const mouseDownColorBar = event => {
        buttonDownColorBar = true

        colorBar.setPointerCapture(event.pointerId)

        colorPicker.style.left = event.offsetX + 'px'
        setColor(event.offsetX)
    }

    const mouseUp = event => {
        buttonDown = false
    }

    const mouseUpColorBar = event => {
        buttonDownColorBar = false
        colorBar.releasePointerCapture(event.pointerId)
    }

    const mouseMove = event => {
        if (!buttonDown) return
        
        const pos = [event.clientX, event.clientY]
        drawPoint(pos, drawColor, drawSize)
        
        const point = {pos, color: drawColor, r: drawSize}
        pointsArray.push(point)
        sendPoint(point)
    }

    const mouseMoveColorBar = event => {
        if (!buttonDownColorBar) return

        const newXPos = Math.min(Math.max(event.offsetX, 0), 300)

        colorPicker.style.left = newXPos + 'px'
        
        setColor(newXPos)
    }

    const wheel = event => {
        drawSize -= event.deltaY/53
        if (drawSize < 0) drawSize = 0
    }

    const mouseDownClearText = () => {
        posArray = []
        clearScreen()
    }

    const setColor = xPos => {
        drawColor = `hsl(${xPos*360/300}, 100%, 50%)`
    }

    const sendPoint = point => {
        send({
            type: 'point',
            data: {
                point,
                sessionId: pathname,
            },
        })
    }

    window.addEventListener('resize', onWindowResize);
    canvas.addEventListener('pointerdown', mouseDown)
    colorBar.addEventListener('pointerdown', mouseDownColorBar)
    colorBar.addEventListener('pointermove', mouseMoveColorBar)
    colorBar.addEventListener('pointerup', mouseUpColorBar)
    clearText.addEventListener('pointerdown', mouseDownClearText)
    document.addEventListener('pointerup', mouseUp)
    document.addEventListener('pointermove', mouseMove)
    document.addEventListener('wheel', wheel)





    

    // const drawScreen = () => {
    //     ctx.fillStyle = drawColor;
    //     posArray.forEach(pos => {
    //         ctx.beginPath()
    //         ctx.arc(pos[0], pos[1], 50, 0, 2 * Math.PI)
    //         ctx.fill()
    //     })
    // }

    const { hostname, pathname } = location

    const localhost = hostname === 'localhost'

    const WS_PORT = 4000

    let socket = null
    let connected = false
    let connecting = false

    function send(data) {
        if (!connected) {
            throw new Error('WebSocket is not connected')
        }
        const value = JSON.stringify(data)
        socket.send(value)
    }

    function connect() {
        connecting = true

        let url

        if (localhost) {
            url = `ws://${hostname}:${WS_PORT}`
        } else {
            url = `wss://${hostname}`
        }

        console.log('socket', 'url', url)

        socket = new WebSocket(url)

        socket.addEventListener('open', function(event) {
            console.log('socket', 'open')
            connected = true
            send({
                type: 'init',
                data: {
                    points: pointsArray,
                    sessionId: pathname,
                },
            })
        })

        socket.addEventListener('close', function(event) {
            console.log('socket', 'close')
            connected = false
        })

        socket.addEventListener('message', event => {
            const { data: message } = event
            const data = JSON.parse(message)
            console.log('socket', 'message', data)
        })

        socket.addEventListener('error', event => {
            console.log('socket', 'error', event)
        })
    }

    function disconnect() {
        socket.close()
        socket = null
    }

    connect()
</script>

</html>